<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Position Sizer</title>

  <!-- PWA manifest & icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root {
      --bg-light: #ffffff;
      --text-light: #000000;
      --bg-dark: #121212;
      --text-dark: #e0e0e0;
    }
    body {
      font-family: sans-serif;
      margin: 0; padding: 1rem;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .container { display: flex; gap: 1rem; flex-wrap: wrap; }
    .main { flex: 1 1 60%; min-width: 300px; }
    .sidebar { flex: 1 1 30%; min-width: 200px; }
    label { font-weight: bold; display: block; margin-top: 1rem; }
    input, select, button {
      width: 100%; padding: 0.5rem; margin-top: 0.25rem; box-sizing: border-box;
    }
    .output { margin-top: 1.5rem; font-size: 1.1rem; line-height: 1.4; }
    .list {
      list-style: none; padding-left: 0; margin-top: 0.5rem;
      max-height: 200px; overflow-y: auto; border: 1px solid #ccc;
    }
    .list li:hover { background: rgba(0,0,0,0.1); cursor: pointer; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Position Sizer</h1>
    <button id="themeToggle">Toggle Theme</button>
  </div>

  <div class="container">
    <div class="main">
      <label for="accountBalance">Account Balance ($)</label>
      <input type="number" id="accountBalance" placeholder="e.g. 20000">

      <label for="riskType">Risk Type</label>
      <select id="riskType">
        <option value="dollar">Fixed Dollar</option>
        <option value="percent">Percent of Equity</option>
      </select>

      <label id="riskLabel" for="riskAmount">Risk Amount ($)</label>
      <input type="number" id="riskAmount" placeholder="e.g. 100">

      <label for="direction">Direction</label>
      <select id="direction">
        <option value="long">Long</option>
        <option value="short">Short</option>
      </select>

      <label for="instrument">Instrument</label>
      <select id="instrument">
        <option value="MNQ">MNQ</option>
        <option value="MES">MES</option>
        <option value="MGC">MGC</option>
        <option value="MCL">MCL</option>
        <option value="MYM">MYM</option>
        <option value="M2K">M2K</option>
      </select>

      <label for="levelPrice">Level Price</label>
      <input type="number" id="levelPrice" placeholder="e.g. 10000">

      <label for="atr">ATR (points)</label>
      <input type="number" id="atr" placeholder="e.g. 8">

      <label for="stopPoints">Stop Points</label>
      <input type="number" id="stopPoints" readonly>

      <label for="entryPrice">Entry Price</label>
      <input type="number" id="entryPrice" placeholder="e.g. 10005">

      <label for="rr">Risk:Reward Ratio (e.g. 2)</label>
      <input type="number" id="rr" placeholder="e.g. 2">

      <div class="output">
        <div>Stop Price: <span id="stopPrice">-</span></div>
        <div>Actual Risk (points): <span id="actualRiskPoints">-</span></div>
        <div>Risk per Contract ($): <span id="perContractRisk">-</span></div>
        <div>Contracts: <span id="contracts">0</span></div>
        <div>Total Risk ($): <span id="totalRisk">0.00</span></div>
        <div>Target Price: <span id="targetPrice">-</span></div>
      </div>
    </div>

    <div class="sidebar">
      <h2>Presets</h2>
      <button id="savePresetBtn">Save Preset</button>
      <ul id="presetsList" class="list"></ul>

      <h2>History</h2>
      <button id="exportHistoryBtn">Export History</button>
      <ul id="historyList" class="list"></ul>
    </div>
  </div>

  <script>
    // Tick value updates: 1pt MNQ=$2, MGC=$10, etc.
    const tickValues = { MNQ:2, MES:5, MGC:10, MCL:10, MYM:10, M2K:1 };

    const acctEl = document.getElementById('accountBalance'),
          typeEl = document.getElementById('riskType'),
          amtEl  = document.getElementById('riskAmount'),
          lblEl  = document.getElementById('riskLabel'),
          dirEl  = document.getElementById('direction'),
          instEl = document.getElementById('instrument'),
          lvlEl  = document.getElementById('levelPrice'),
          atrEl  = document.getElementById('atr'),
          stopEl = document.getElementById('stopPoints'),
          entEl  = document.getElementById('entryPrice'),
          rrEl   = document.getElementById('rr');

    const stopPriceEl = document.getElementById('stopPrice'),
          actualPtsEl = document.getElementById('actualRiskPoints'),
          perRiskEl   = document.getElementById('perContractRisk'),
          ctrEl       = document.getElementById('contracts'),
          totalEl     = document.getElementById('totalRisk'),
          tgtEl       = document.getElementById('targetPrice');

    const saveBtn = document.getElementById('savePresetBtn'),
          presetsList = document.getElementById('presetsList'),
          historyList = document.getElementById('historyList'),
          exportBtn   = document.getElementById('exportHistoryBtn'),
          themeBtn    = document.getElementById('themeToggle');

    let presets = JSON.parse(localStorage.getItem('presets')||'[]'),
        history = JSON.parse(localStorage.getItem('history')||'[]');

    function calculate(){
      // compute risk amount in $ from fixed or % of equity
      let riskAmt = parseFloat(amtEl.value)||0;
      if(typeEl.value==='percent') {
        riskAmt = (parseFloat(amtEl.value)||0)/100 * (parseFloat(acctEl.value)||0);
      }
      const lvl = parseFloat(lvlEl.value)||0,
            atr = parseFloat(atrEl.value)||0,
            ent = parseFloat(entEl.value)||0,
            dir = dirEl.value;
      // stop price
      const stopPrice = dir==='long'? lvl-atr : lvl+atr;
      stopPriceEl.textContent = stopPrice.toFixed(2);
      stopEl.value = Math.abs(atr).toFixed(2);
      // actual risk pts
      const actualPts = Math.abs(ent - lvl) + atr;
      actualPtsEl.textContent = actualPts.toFixed(2);
      // perâ€‘contract risk $
      const perRisk = actualPts * (tickValues[instEl.value]||0);
      perRiskEl.textContent = perRisk.toFixed(2);
      // contracts
      const ctr = perRisk>0? Math.floor(riskAmt/perRisk) : 0;
      ctrEl.textContent = ctr;
      // total risk $
      const tot = ctr * perRisk;
      totalEl.textContent = tot.toFixed(2);
      // target price
      const rr = parseFloat(rrEl.value)||0;
      const tgt = rr>0
        ? (dir==='long'? ent + actualPts*rr : ent - actualPts*rr)
        : '-';
      tgtEl.textContent = rr>0? tgt.toFixed(2) : '-';
      // label update
      lblEl.textContent = typeEl.value==='percent'
        ? 'Risk Amount (%)' : 'Risk Amount ($)';
      // push to history
      if(ctr>0){
        const rec = {
          t: new Date().toLocaleString(),
          instr: instEl.value,
          d: dir,
          c: ctr,
          r: tot.toFixed(2),
          tp: rr>0? tgt.toFixed(2): '-'
        };
        history.unshift(rec);
        if(history.length>20) history.pop();
        localStorage.setItem('history', JSON.stringify(history));
        renderHistory();
      }
    }

    function renderPresets(){
      presetsList.innerHTML='';
      presets.forEach((p,i)=>{
        const li=document.createElement('li');
        li.textContent=p.name;
        li.onclick=()=>loadPreset(i);
        presetsList.appendChild(li);
      });
    }

    function savePreset(){
      const name = prompt('Name this preset:');
      if(!name) return;
      presets.push({
        name,
        type: typeEl.value, amt: amtEl.value,
        acct: acctEl.value,
        instr: instEl.value, dir: dirEl.value,
        lvl: lvlEl.value, atr: atrEl.value,
        ent: entEl.value, rr: rrEl.value
      });
      localStorage.setItem('presets', JSON.stringify(presets));
      renderPresets();
    }

    function loadPreset(i){
      const p=presets[i];
      typeEl.value=p.type; amtEl.value=p.amt; acctEl.value=p.acct;
      instEl.value=p.instr; dirEl.value=p.dir;
      lvlEl.value=p.lvl; atrEl.value=p.atr;
      entEl.value=p.ent; rrEl.value=p.rr;
      calculate();
    }

    function renderHistory(){
      historyList.innerHTML='';
      history.forEach(r=>{
        const li=document.createElement('li');
        li.textContent = r.t + ' | ' + r.instr + ' ' + r.d +
          ' | ctrs: ' + r.c + ' | risk $' + r.r +
          (r.tp!=='-'? ' | tgt ' + r.tp : '');
        historyList.appendChild(li);
      });
    }

    function exportHistory(){
      let csv = 'Time,Instr,Dir,Contracts,Risk,Target\\n';
      history.forEach(r=>{
        csv += '"' + r.t + '",' + r.instr + ',' + r.d + ',' +
               r.c + ',' + r.r + ',' + r.tp + '\\n';
      });
      const blob = new Blob([csv],{type:'text/csv'}),
            url = URL.createObjectURL(blob),
            a = document.createElement('a');
      a.href=url; a.download='history.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function toggleTheme(){
      document.body.classList.toggle('dark');
    }

    // hook events
    [acctEl,typeEl,amtEl,dirEl,instEl,lvlEl,atrEl,entEl,rrEl]
      .forEach(e=>e.addEventListener('input', calculate));
    saveBtn.onclick = savePreset;
    exportBtn.onclick = exportHistory;
    themeBtn.onclick = toggleTheme;

    // init
    renderPresets();
    renderHistory();
    calculate();

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
