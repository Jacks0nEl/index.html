<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Position Sizer</title>

  <!-- PWA manifest & icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root {
      --bg-light: #ffffff;
      --text-light: #000000;
      --bg-dark: #121212;
      --text-dark: #e0e0e0;
    }
    body {
      font-family: sans-serif;
      margin: 0; padding: 1rem;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .container { display: flex; gap: 1rem; flex-wrap: wrap; }
    .main { flex: 1 1 60%; min-width: 300px; }
    .sidebar { flex: 1 1 30%; min-width: 200px; }
    label { font-weight: bold; display: block; margin-top: 1rem; }
    input, select, button {
      width: 100%; padding: 0.5rem; margin-top: 0.25rem; box-sizing: border-box;
    }
    .output { margin-top: 1.5rem; font-size: 1.1rem; line-height: 1.4; }
    .list {
      list-style: none; padding-left: 0; margin-top: 0.5rem;
      max-height: 200px; overflow-y: auto; border: 1px solid #ccc;
    }
    .list li:hover { background: rgba(0,0,0,0.1); cursor: pointer; }
    .error {
      color: red; font-size: 0.9rem; display: none; margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Position Sizer</h1>
    <button id="themeToggle">Toggle Theme</button>
  </div>

  <div class="container">
    <div class="main">
      <!-- Main Inputs -->
      <label for="accountBalance">Account Balance ($)</label>
      <input type="number" id="accountBalance" placeholder="e.g. 20000">
      <span class="error" id="acctError"></span>

      <label for="riskType">Risk Type</label>
      <select id="riskType">
        <option value="dollar">Fixed Dollar</option>
        <option value="percent">Percent of Equity</option>
      </select>

      <label id="riskLabel" for="riskAmount">Risk Amount ($)</label>
      <input type="number" id="riskAmount" placeholder="e.g. 100">
      <span class="error" id="amtError"></span>

      <label for="direction">Direction</label>
      <select id="direction">
        <option value="long">Long</option>
        <option value="short">Short</option>
      </select>

      <label for="instrument">Instrument</label>
      <select id="instrument"></select>

      <label for="levelPrice">Level Price</label>
      <input type="number" id="levelPrice" placeholder="e.g. 10000">
      <span class="error" id="levelError"></span>

      <label for="atr">ATR (points)</label>
      <input type="number" id="atr" placeholder="e.g. 8">
      <span class="error" id="atrError"></span>

      <label for="stopPoints">Stop Points</label>
      <input type="number" id="stopPoints" readonly>

      <label for="entryPrice">Entry Price</label>
      <input type="number" id="entryPrice" placeholder="e.g. 10005">
      <span class="error" id="entryError"></span>

      <label for="rr">Risk:Reward Ratio (e.g. 2)</label>
      <input type="number" id="rr" placeholder="e.g. 2">
      <span class="error" id="rrError"></span>

      <div class="output">
        <div>Stop Price: <span id="stopPrice">-</span></div>
        <div>Actual Risk (points): <span id="actualRiskPoints">-</span></div>
        <div>Risk per Contract ($): <span id="perContractRisk">-</span></div>
        <div>Contracts: <span id="contracts">0</span></div>
        <div>Total Risk ($): <span id="totalRisk">0.00</span></div>
        <div>Target Price: <span id="targetPrice">-</span></div>
      </div>
    </div>

    <div class="sidebar">
      <!-- Instrument Management -->
      <h2>Instruments</h2>
      <button id="addInstBtn">Add Instrument</button>
      <ul id="instList" class="list"></ul>

      <!-- Presets -->
      <h2>Presets</h2>
      <button id="savePresetBtn">Save Preset</button>
      <ul id="presetsList" class="list"></ul>

      <!-- History -->
      <h2>History</h2>
      <button id="exportHistoryBtn">Export History</button>
      <ul id="historyList" class="list"></ul>
    </div>
  </div>

  <script>
    // Default instruments with $ per point values
    const defaultInstruments = [
      { symbol: 'ES', value: 50 },
      { symbol: 'MES', value: 5 },
      { symbol: 'NQ', value: 20 },
      { symbol: 'MNQ', value: 2 },
      { symbol: 'YM', value: 5 },
      { symbol: 'MYM', value: 0.5 },
      { symbol: 'RTY', value: 50 },
      { symbol: 'M2K', value: 5 },
      { symbol: 'GC', value: 100 },
      { symbol: 'MGC', value: 10 },
      { symbol: 'SI', value: 250 },
      { symbol: 'SIL', value: 50 },
      { symbol: 'CL', value: 1000 },
      { symbol: 'QM', value: 1250 },
      { symbol: 'NG', value: 10000 },
      { symbol: 'QG', value: 12500 },
      { symbol: 'ZC', value: 50 },
      { symbol: 'ZS', value: 50 },
      { symbol: 'ZW', value: 50 },
      { symbol: '6E', value: 1250 },
      { symbol: '6B', value: 625 },
      { symbol: '6J', value: 12500 },
      { symbol: '6C', value: 1000 },
      { symbol: '6S', value: 1250 },
      { symbol: 'HE', value: 400 },
      { symbol: 'LE', value: 400 },
      { symbol: 'ZN', value: 1000 },
      { symbol: 'ZB', value: 1000 }
    ];
    const storedInstruments = JSON.parse(localStorage.getItem('instruments'));
let instruments = (Array.isArray(storedInstruments) && storedInstruments.length > 0)
    ? storedInstruments
    : defaultInstruments;

    const acctEl = document.getElementById('accountBalance'),
          typeEl = document.getElementById('riskType'),
          amtEl  = document.getElementById('riskAmount'),
          lblEl  = document.getElementById('riskLabel'),
          dirEl  = document.getElementById('direction'),
          instEl = document.getElementById('instrument'),
          lvlEl  = document.getElementById('levelPrice'),
          atrEl  = document.getElementById('atr'),
          stopEl = document.getElementById('stopPoints'),
          entEl  = document.getElementById('entryPrice'),
          rrEl   = document.getElementById('rr');

    const stopPriceEl = document.getElementById('stopPrice'),
          actualPtsEl= document.getElementById('actualRiskPoints'),
          perRiskEl  = document.getElementById('perContractRisk'),
          ctrEl      = document.getElementById('contracts'),
          totalEl    = document.getElementById('totalRisk'),
          tgtEl      = document.getElementById('targetPrice');

    const addInstBtn  = document.getElementById('addInstBtn'),
          instList    = document.getElementById('instList'),
          saveBtn     = document.getElementById('savePresetBtn'),
          presetsList = document.getElementById('presetsList'),
          historyList = document.getElementById('historyList'),
          exportBtn   = document.getElementById('exportHistoryBtn'),
          themeBtn    = document.getElementById('themeToggle');

    let presets = JSON.parse(localStorage.getItem('presets'))||[],
        history = JSON.parse(localStorage.getItem('history'))||[];

    // Utility: show/clear errors
    function showError(el,msg){el.textContent=msg;el.style.display='block';}
    function clearErrors(){document.querySelectorAll('.error').forEach(e=>e.style.display='none');}

    // Render instruments dropdown & list
    function renderInstruments(){
      instEl.innerHTML='';
      instruments.forEach(i=>{
        const opt=document.createElement('option');
        opt.value=i.symbol; opt.textContent=`${i.symbol} ($${i.value}/pt)`;
        instEl.appendChild(opt);
      });
      instList.innerHTML='';
      instruments.forEach(i=>{
        const li=document.createElement('li');
        li.textContent=`${i.symbol}: $${i.value}/pt`;
        instList.appendChild(li);
      });
    }

    // Add instrument via prompt
    function addInstrument(){
      const sym=prompt('New symbol (e.g. XYZ):'); if(!sym) return;
      const val=prompt('Value per point in $ (e.g. 1):');
      const v=parseFloat(val);
      if(isNaN(v)||v<=0){alert('Invalid value');return;}
      instruments.push({symbol:sym.toUpperCase(),value:v});
      localStorage.setItem('instruments',JSON.stringify(instruments));
      renderInstruments(); clearFields(); calculate();
    }

    // Validation
    function validateInputs(){
      clearErrors(); let ok=true;
      const acct=parseFloat(acctEl.value)```
